<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Page/Section</title>
</head>
<body>
    <div class="wrapper row">
        <div class="content col-lg-3">
            <h3>Verification of Certificate</h3><br>
            <input type="text" id="address" name="address" required placeholder="User Wallet Address"><br><br>
            <input type="text" id="toaddress" name="toaddress" required placeholder="Contract/To Address"><br><br>
            <!-- <button class="button-29" type="submit" id="submit" onclick="callWallet()">Check Wallet</button><br><br> -->
            <button class="button-29" onclick="callTransaction()">Check My Transactions</button><br><br>
            <p id="demo"></p>
        </div>
        <div class="details col-lg-8">
            <div id="table"><p class="intro">Verification Report<p><p id="list"></p></div>
        </div>
    </div>
    <script>
        const apiKey = "6R4H8RYQHN4WS7TB5JMNPUSRTJFIITGDF4" 

        function callTransaction(){
            const addr = document.getElementById("address").value;
            const toaddr = document.getElementById("toaddress").value;

            const para1 = document.getElementById("list");
            const tb = document.getElementById("table");

            var txData;
            var contractData;

            if(addr.length == 0){
                alert("Wallet adddress is empty!");
                addr.focus;
                return false;
            }
            else if (toaddr.length == 0){
                alert("Contract/To Address is empty!");
                toaddr.focus;
                return false;
            }
            else{
                apiURL = "https://api-testnet.polygonscan.com/api?module=account&action=txlistinternal&address="+addr+"&startblock=0&endblock=99999999&page=1&offset=10&sort=asc&apikey="+apiKey;
                const checkResponseStatus = (response) => {
                    if (!response.ok) throw new Error(`Status code error: ${response.status}`);
	                return response.json();
                };

                fetch(apiURL).then(checkResponseStatus).then(data =>{
                    console.log(data)
                    if(data.result.length == 0){
                        tb.innerHTML = "<h4>You don't have any transactions</h4>";
                    }else{
                        console.log('here');
                        console.log(data.result);
                        data.result.forEach((tx)=>{
                            const timeStamp = new Date(tx.timeStamp*1000).toLocaleString("en-UK");
                            const value = tx.value
                            console.log(timeStamp, value)
                            if(tx.from == toaddr){
                                const transactionValue = value *  Math.pow(10,-18);
                                tb.innerHTML = "<br><br><h4>Your last few transaction values (in BNB) are: </h4><br><p>Date</p><p>"+timeStamp+"</p><p>Value</p><p>"+transactionValue+"</p><p>Verifier</p><p>"+tx.from+"</p>";
                            }
                        })
                    }
                })
                .catch(err => para1.innerHTML = "Error in transaction/no transaction found"); 
            } 
        }

    </script>
</body>
</html>